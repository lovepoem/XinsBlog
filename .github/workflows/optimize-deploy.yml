name: ä¼˜åŒ–æ„å»ºå’Œéƒ¨ç½²

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install -g hexo-cli

    - name: ä¼˜åŒ–å›¾ç‰‡
      run: |
        # å®‰è£…å›¾ç‰‡ä¼˜åŒ–å·¥å…·
        sudo apt-get update
        sudo apt-get install -y jpegoptim optipng
        
        # ä¼˜åŒ–JPEGå›¾ç‰‡
        find source/images -name "*.jpg" -o -name "*.jpeg" | xargs jpegoptim --max=85 --strip-all
        
        # ä¼˜åŒ–PNGå›¾ç‰‡
        find source/images -name "*.png" | xargs optipng -o7

    - name: æ„å»ºç½‘ç«™
      run: |
        export NODE_ENV=production
        hexo clean
        hexo generate
        
        # ç”ŸæˆGzipå‹ç¼©æ–‡ä»¶
        find public -name "*.html" -o -name "*.css" -o -name "*.js" | xargs gzip -k

    - name: æ€§èƒ½æ£€æµ‹
      run: |
        node performance-check.js || true

    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        cname: wangxin.io
        
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      run: |
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ ç½‘ç«™åœ°å€: https://wangxin.io/"
        echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
        du -sh public/
